<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Nodejs开源项目怎么样写测试、CI和代码测试覆盖率 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="wx 是一个不错的微信应用框架，接口和网站做的也不错，和wechat-api是类似的项目
群里有人问哪个好
朴灵说：“不写测试的项目都不是好项目”
确实wx目前还没有测试，对于一个开源项目来说，没有测试和代码覆盖率是不完善的，而且从技术选型来说，大多是不敢选的。
那么Nodejs开源项目里怎么样写测试、CI和代码测试覆盖率呢？
测试目前主流的就bdd和tdd，自己查一下差异
推荐

mocha和t">
<meta property="og:type" content="article">
<meta property="og:title" content="Nodejs开源项目怎么样写测试、CI和代码测试覆盖率">
<meta property="og:url" content="http://yoursite.com/2015/06/28/think/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="wx 是一个不错的微信应用框架，接口和网站做的也不错，和wechat-api是类似的项目
群里有人问哪个好
朴灵说：“不写测试的项目都不是好项目”
确实wx目前还没有测试，对于一个开源项目来说，没有测试和代码覆盖率是不完善的，而且从技术选型来说，大多是不敢选的。
那么Nodejs开源项目里怎么样写测试、CI和代码测试覆盖率呢？
测试目前主流的就bdd和tdd，自己查一下差异
推荐

mocha和t">
<meta property="og:image" content="http://yoursite.com/img/2015-06-26/4.png">
<meta property="og:image" content="http://yoursite.com/img/2015-06-26/5.png">
<meta property="og:image" content="http://yoursite.com/img/2015-06-26/1.png">
<meta property="og:image" content="https://coveralls.io/repos/moajs/mongoosedao/badge.png">
<meta property="og:image" content="http://yoursite.com/img/2015-06-26/2.png">
<meta property="og:image" content="http://yoursite.com/img/2015-06-26/3.png">
<meta property="og:image" content="https://travis-ci.org/moajs/mongoosedao.png?branch=master">
<meta property="og:image" content="https://coveralls.io/repos/moajs/mongoosedao/badge.png">
<meta property="og:image" content="http://yoursite.com/img/node全栈-公众号.png">
<meta property="og:updated_time" content="2015-08-07T06:06:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nodejs开源项目怎么样写测试、CI和代码测试覆盖率">
<meta name="twitter:description" content="wx 是一个不错的微信应用框架，接口和网站做的也不错，和wechat-api是类似的项目
群里有人问哪个好
朴灵说：“不写测试的项目都不是好项目”
确实wx目前还没有测试，对于一个开源项目来说，没有测试和代码覆盖率是不完善的，而且从技术选型来说，大多是不敢选的。
那么Nodejs开源项目里怎么样写测试、CI和代码测试覆盖率呢？
测试目前主流的就bdd和tdd，自己查一下差异
推荐

mocha和t">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-think" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/28/think/" class="article-date">
  <time datetime="2015-06-27T16:00:00.000Z" itemprop="datePublished">2015-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Nodejs开源项目怎么样写测试、CI和代码测试覆盖率
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>wx 是一个不错的微信应用框架，接口和网站做的也不错，和wechat-api是类似的项目</p>
<p>群里有人问哪个好</p>
<p>朴灵说：“不写测试的项目都不是好项目”</p>
<p>确实wx目前还没有测试，对于一个开源项目来说，没有测试和代码覆盖率是不完善的，而且从技术选型来说，大多是不敢选的。</p>
<p>那么Nodejs开源项目里怎么样写测试、CI和代码测试覆盖率呢？</p>
<h2 id="测试">测试</h2><p>目前主流的就bdd和tdd，自己查一下差异</p>
<p>推荐</p>
<ul>
<li>mocha和tape</li>
</ul>
<p>另外Jasmine也挺有名，angularjs用它，不过挺麻烦的，还有一个选择是qunit，最初是为jquery测试写的，在nodejs里用还是觉得怪怪的。</p>
<p>如果想简单可以tap，它和tape很像，下文会有详细说明</p>
<h3 id="mocha">mocha</h3><p>mocha是tj写的</p>
<p><a href="https://github.com/mochajs/mocha" target="_blank" rel="external">https://github.com/mochajs/mocha</a></p>
<pre><code>var <span class="built_in">assert</span> = <span class="built_in">require</span>(<span class="string">"assert"</span>)
describe(<span class="string">'truth'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{
  it(<span class="string">'should find the truth'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{
    <span class="built_in">assert</span>.equal(<span class="number">1</span>, <span class="number">1</span>);
  })
})
</code></pre><p>断言风格，这里默认是assert，推荐使用chaijs这个模块，它提供3种风格</p>
<ul>
<li>Should</li>
<li>Expect</li>
<li>Assert</li>
</ul>
<p>rspec里推荐用expect，其实看个人习惯</p>
<p>比较典型一个mocha例子</p>
<pre><code><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert;
<span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect;
<span class="built_in">require</span>(<span class="string">'chai'</span>).should();


describe(<span class="string">'Test'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    before(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="comment">// runs before all tests in this block</span>

  })
  after(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// runs after all tests in this block</span>
  })
  beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// runs before each test in this block</span>
  })
  afterEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// runs after each test in this block</span>
  })

  describe(<span class="string">'#test()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    it(<span class="string">'should return ok when test finished'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>{
      assert.equal(<span class="string">'sang_test2'</span>, <span class="string">'sang_test2'</span>);
      <span class="keyword">var</span> foo = <span class="string">'bar'</span>;
      expect(foo).to.equal(<span class="string">'bar'</span>);
      done()
    })
  })
})
</code></pre><p>说明</p>
<ul>
<li>理解测试生命周期</li>
<li>理解bdd测试写法</li>
</ul>
<p>单元测试需要的各个模块说明</p>
<ul>
<li>mocha（Mocha is a feature-rich JavaScript test framework running on node.js and the browser, making asynchronous testing simple and fun.）</li>
<li>chai（Chai is a BDD / TDD assertion library for node and the browser that can be delightfully paired with any javascript testing framework.）</li>
<li>sinon（Standalone test spies, stubs and mocks for JavaScript.）</li>
<li>zombie (页面事件模拟Zombie.js is a lightweight framework for testing client-side JavaScript code in a simulated environment. No browser required.)</li>
<li>supertest(接口测试 Super-agent driven library for testing node.js HTTP servers using a fluent API)</li>
</ul>
<p>更多的看<a href="http://nodeonly.com/2014/11/24/mongoose-test.html" target="_blank" rel="external">http://nodeonly.com/2014/11/24/mongoose-test.html</a></p>
<p>如果你想真正的玩敏捷，从用户故事开始，那么下面这2个库非常必要</p>
<ul>
<li><a href="http://vowsjs.org/" target="_blank" rel="external">http://vowsjs.org/</a></li>
<li><a href="https://github.com/cucumber/cucumber-js" target="_blank" rel="external">https://github.com/cucumber/cucumber-js</a></li>
</ul>
<p>啊，黄瓜。。。。</p>
<p>cucumber作为BDD（行为驱动测试）的自动化测试工具，可以很好的帮助进行功能测试。它将功能拆分为一个个的场景（可以理解为小功能点），每个场景内可以独立的做数据初始，然后再对初始的数据进行测试，检测是否达到预期的效果。</p>
<h3 id="tape：像代码一样跑测试">tape：像代码一样跑测试</h3><p>tape是substack写的测试框架</p>
<p><a href="https://github.com/substack/tape" target="_blank" rel="external">https://github.com/substack/tape</a></p>
<pre><code><span class="keyword">var</span> test = <span class="built_in">require</span>(<span class="string">'tape'</span>).test;
test(<span class="string">'equivalence'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>{
    t.equal(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'these two numbers are equal'</span>);
    t.end();
});
</code></pre><p>tape是非常简单的测试框架，核心价值观是”Tests are code”，所以你可以像代码一样跑测试，</p>
<p>比如</p>
<pre><code>node <span class="keyword">test</span>/<span class="keyword">test</span>.js
</code></pre><p>写个脚本就无比简单了。当然如果你想加’test runner’ 库也有现成的。</p>
<h3 id="The_Test_Anything_Protocol">The Test Anything Protocol</h3><p>TAP全称是<a href="https://en.wikipedia.org/wiki/Test_Anything_Protocol" target="_blank" rel="external">Test Anything Protocol</a></p>
<p>它是可靠性测试的一种（tried &amp; true）实现</p>
<p>从1987就有了，有很多语言都实现了。</p>
<p>它说白点就是用贼简单的方式来格式化测试结果，比如</p>
<pre><code>TAP version <span class="number">13</span>
<span class="preprocessor"># equivalence</span>
ok <span class="number">1</span> these two numbers are equal

<span class="number">1.</span><span class="number">.1</span>
<span class="preprocessor"># tests <span class="number">1</span></span>
<span class="preprocessor"># pass  <span class="number">1</span></span>

<span class="preprocessor"># ok</span>
</code></pre><p>比如node里的实现<a href="https://github.com/isaacs/node-tap" target="_blank" rel="external">https://github.com/isaacs/node-tap</a></p>
<pre><code>var tap = <span class="built_in">require</span>(<span class="string">'tap'</span>)
<span class="comment">
// you can test stuff just using the top level object.</span><span class="comment">
// no suites or subtests required.</span>

tap.equal(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'check if numbers still work'</span>)
tap.notEqual(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'1 should not equal 2'</span>)
<span class="comment">
// also you can group things into sub-tests.</span><span class="comment">
// Sub-tests will be run in sequential order always,</span><span class="comment">
// so they're great for async things.</span>

tap.test(<span class="string">'first stuff'</span>, <span class="function"><span class="keyword">function</span> (<span class="title">t</span>) {</span>
  t.ok(<span class="constant">true</span>, <span class="string">'true is ok'</span>)
  t.similar({<span class="operator">a</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]}, {<span class="operator">a</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]})
 <span class="comment"> // call t.end() when you're done</span>
  t.<span class="keyword">end</span>()
})
</code></pre><p>一定要区分tap和tape，不要弄混了</p>
<h2 id="科普一下什么是CI">科普一下什么是CI</h2><p>科普一下，CI = Continuous integration 持续集成</p>
<p>Martin Fowler对持续集成是这样定义的:</p>
<p>持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件。</p>
<p>它可以</p>
<ul>
<li>减少风险</li>
<li>减少重复过程</li>
<li>任何时间、任何地点生成可部署的软件</li>
<li>增强项目的可见性</li>
<li>建立团队对开发产品的信心</li>
</ul>
<p>要素</p>
<p>1.统一的代码库<br>2.自动构建<br>3.自动测试<br>4.每个人每天都要向代码库主干提交代码<br>5.每次代码递交后都会在持续集成服务器上触发一次构建<br>6.保证快速构建<br>7.模拟生产环境的自动测试<br>8.每个人都可以很容易的获取最新可执行的应用程序<br>9.每个人都清楚正在发生的状况<br>10.自动化的部署</p>
<p>也就是说，测试不通过不能部署，只有提交到服务器上，就可以自动跑测试，测试通过后，就可以部署到服务器上了（注意是”staging”, 而非”production”）。</p>
<p>一般最常的ci软件是jenkins</p>
<p>举个大家熟悉的例子iojs开发中的持续集成就是用的jenkins</p>
<p><a href="https://jenkins-iojs.nodesource.com/" target="_blank" rel="external">https://jenkins-iojs.nodesource.com/</a></p>
<p><img src="/img/2015-06-26/4.png" alt=""></p>
<p>jenkins是自建环境下用的比较多，如果是开源项目，推荐travis-ci</p>
<p><a href="https://travis-ci.org/" target="_blank" rel="external">https://travis-ci.org/</a></p>
<p>对开源项目做持续集成是免费的（非开源的好贵），所以在github集成的基本是最多的。</p>
<p>对nodejs支持的也非常好。</p>
<p>举2个例子</p>
<ul>
<li>express  <a href="https://travis-ci.org/strongloop/express" target="_blank" rel="external">https://travis-ci.org/strongloop/express</a></li>
<li>koa      <a href="https://travis-ci.org/koajs/koa" target="_blank" rel="external">https://travis-ci.org/koajs/koa</a></li>
</ul>
<h2 id="测试报告">测试报告</h2><p>近年随着tdd/bdd，开源项目，和敏捷开发的火热，程序员们不再满足说，我贡献了一个开源项目</p>
<p>要有高要求，我要加测试</p>
<p>要有更高要求，我要把每一个函数都测试到，让别人相信我的代码没有任何问题</p>
<p>上一小节讲的ci，实际上解决了反复测试的自动化问题。但是如何看我的程序里的每一个函数都测试了呢？</p>
<p>答案是测试覆盖率</p>
<p>在nodejs里，推荐<a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="external">istanbul</a></p>
<p>Istanbul - 官方介绍 a JS code coverage tool written in JS</p>
<p>它可以通过3种途径生成覆盖报告</p>
<ul>
<li>cli</li>
<li>代码</li>
<li>gulp插件</li>
</ul>
<p>安装</p>
<pre><code>$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> istanbul</span>
</code></pre><p>执行</p>
<pre><code>$ istanbul cover <span class="keyword">my</span>-test-<span class="keyword">script</span>.js <span class="comment">-- my test args</span>
</code></pre><p>它会生成<code>./coverage</code>目录，这里面就是测试报告</p>
<p>比如我的项目里</p>
<pre><code>./node_modules/.bin/istanbul cover ./node_modules/mocha/bin/_mocha <span class="comment">--report lcovonly</span>
    #MongooseDao()
      ✓ should return ok when record <span class="operator"><span class="keyword">create</span>
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> <span class="keyword">delete</span> fixture-<span class="keyword">user</span>
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> deleteById
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> removeById
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> getById
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> getAll
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> all
      ✓ should <span class="keyword">return</span> ok <span class="keyword">when</span> <span class="built_in">record</span> <span class="keyword">query</span>


  <span class="number">8</span> <span class="keyword">passing</span> (<span class="number">50</span>ms)

=============================================================================
Writing coverage <span class="keyword">object</span> [/<span class="keyword">Users</span>/sang/workspace/moa/mongoosedao/coverage/coverage.<span class="keyword">json</span>]
Writing coverage reports <span class="keyword">at</span> [/<span class="keyword">Users</span>/sang/workspace/moa/mongoosedao/coverage]
=============================================================================

=============================== Coverage summary ===============================
Statements   : <span class="number">47.27</span>% ( <span class="number">26</span>/<span class="number">55</span> )
Branches     : <span class="number">8.33</span>% ( <span class="number">1</span>/<span class="number">12</span> )
Functions    : <span class="number">60</span>% ( <span class="number">9</span>/<span class="number">15</span> )
<span class="keyword">Lines</span>        : <span class="number">47.27</span>% ( <span class="number">26</span>/<span class="number">55</span> )
================================================================================</span>
</code></pre><p>默认，它会生成coverage.json和Icov.info，如果你想生成html也可以的。</p>
<p>比如说，上面的结果47.27%是我测试覆盖的占比，即55个函数，我的测试里只覆盖了26个。</p>
<p>那么我需要有地方能够展示出来啊</p>
<h2 id="实践">实践</h2><p>我们以<a href="https://github.com/moajs/mongoosedao" target="_blank" rel="external">mongoosedao</a>项目为例，介绍一下如何集成测试，ci和测试覆盖率</p>
<p>最终效果如图</p>
<p><img src="/img/2015-06-26/5.png" alt=""></p>
<h3 id="npm_run">npm run</h3><p>package.json里定义自定义执行脚本</p>
<pre><code>"scripts": {
  "<span class="operator"><span class="keyword">start</span><span class="string">": "</span>npm publish .<span class="string">",
  "</span><span class="keyword">test</span><span class="string">": "</span>./node_modules/.<span class="keyword">bin</span>/gulp<span class="string">",
  "</span>mocha<span class="string">": "</span>./node_modules/.<span class="keyword">bin</span>/mocha -u bdd<span class="string">",
  "</span>cov<span class="string">":"</span>./node_modules/.<span class="keyword">bin</span>/istanbul cover ./node_modules/mocha/<span class="keyword">bin</span>/_mocha <span class="comment">--report lcovonly -- -R spec &amp;&amp; cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js &amp;&amp; rm -rf ./coverage"</span>
},</span>
</code></pre><p>除了start和test外，都是自定义任务，其他都要加run命令</p>
<pre><code>npm <span class="command">run</span> mocha
npm <span class="command">run</span> cov
</code></pre><p>更多见<a href="https://cnodejs.org/topic/54646c7f88b869cc33a97924" target="_blank" rel="external">npm-run-test教程</a></p>
<h3 id="gulp_watch">gulp watch</h3><pre><code><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);
<span class="keyword">var</span> watch = <span class="built_in">require</span>(<span class="string">'gulp-watch'</span>);

<span class="keyword">var</span> path = <span class="string">'test/**/*.js'</span>;

gulp.task(<span class="string">'watch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
  gulp.watch([<span class="string">'test/**/*.js'</span>, <span class="string">'lib/*.js'</span>], [<span class="string">'mocha'</span>]);
});

<span class="keyword">var</span> mocha = <span class="built_in">require</span>(<span class="string">'gulp-mocha'</span>);

gulp.task(<span class="string">'mocha'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
    <span class="keyword">return</span> gulp.src(path , {read: <span class="literal">false</span>})
        <span class="comment">// gulp-mocha needs filepaths so you can't have any plugins before it </span>
        .pipe(mocha({reporter: <span class="string">'spec'</span>}));
});


gulp.task(<span class="string">'default'</span>,[<span class="string">'mocha'</span>, <span class="string">'watch'</span>]);
</code></pre><p>这样就可以执行gulp的时候，当文件变动，会自动触发mocha测试，简化每次都输入npm test这样的操作。</p>
<p>当然你可以玩更多的gulp，如果不熟悉，参考</p>
<ul>
<li><a href="https://cnodejs.org/topic/5508f03d3135610a365b013d" target="_blank" rel="external">介绍gulp的一张不错的图</a></li>
<li><a href="https://github.com/streakq/js-tools-best-practice/blob/master/doc/Gulp.md" target="_blank" rel="external">gulp实践</a></li>
</ul>
<h3 id="创建-travis-yml">创建<code>.travis.yml</code></h3><p>项目根目录下，和package.json平级</p>
<pre><code>language: node_js
repo_token: COVERALLS.IO_TOKEN
services: mongodb
node_js:
  - <span class="string">"0.12"</span>
  - <span class="string">"0.11"</span>
  - <span class="string">"0.10"</span>
script: npm run mocha
after_script:
  npm run cov
</code></pre><p>说明</p>
<ul>
<li>如果依赖mongo等数据库，一定要写services</li>
<li>把测试覆盖率放到执行测试之后，避免报402错误</li>
</ul>
<p>在travis-ci.org上，github授权，添加repo都比较简单</p>
<p>添加之后，就可以看到，比如</p>
<p><a href="https://travis-ci.org/moajs/mongoosedao" target="_blank" rel="external">https://travis-ci.org/moajs/mongoosedao</a></p>
<p>travis-ci实际上根据github的代码变动进行自动持续构建,但是有的时候它不一定更新，或者说，你需要手动选一下：</p>
<p><img src="/img/2015-06-26/1.png" alt=""></p>
<p>点击<code># 10 passed</code>,这样就可以强制它手动集成了。</p>
<p>其他都很简单，注意替换COVERALLS.IO_TOKEN即可。</p>
<h3 id="创建_-coveralls-yml">创建 <code>.coveralls.yml</code></h3><p><a href="https://coveralls.io/是一个代码测试覆盖率的网站，" target="_blank" rel="external">https://coveralls.io/是一个代码测试覆盖率的网站，</a></p>
<p>nodejs下面的代码测试覆盖率，原理是通过<a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="external">istanbul</a>生成测试数据，上传到coveralls网站上，然后以badge的形式展示出来</p>
<p>比如</p>
<p><a href="https://coveralls.io/r/moajs/mongoosedao" target="_blank" rel="external"><img src="https://coveralls.io/repos/moajs/mongoosedao/badge.png" alt="Coverage Status"></a></p>
<p>具体实践和travis-ci类似，用github账号登陆，然后添加repo，然后在项目根目录下，和package.json平级，增加<code>.coveralls.yml</code></p>
<pre><code><span class="attribute">service_name</span>: <span class="string">travis-pro</span>
<span class="attribute">repo_token</span>: <span class="string">99UNur6O7ksBqiwgg1NG1sSFhmu78A0t7</span>
</code></pre><p>在上，第一次添加repo，显示的是“SET UP COVERALLS”，里面有token，需要放到<code>.coveralls.yml</code>里，</p>
<p><img src="/img/2015-06-26/2.png" alt=""></p>
<p>如果成功提交了，就可以看到数据了</p>
<p><img src="/img/2015-06-26/3.png" alt=""></p>
<h3 id="在readme-md里增加badge">在readme.md里增加badge</h3><pre><code>[<span class="link_label">![Build Status</span>](<span class="link_url">https://travis-ci.org/moajs/mongoosedao.png?branch=master</span>)](<span class="link_url">https://travis-ci.org/moajs/mongoosedao</span>)
[<span class="link_label">![Coverage Status</span>](<span class="link_url">https://coveralls.io/repos/moajs/mongoosedao/badge.png</span>)](<span class="link_url">https://coveralls.io/r/moajs/mongoosedao</span>)
</code></pre><p>它就会显示如下</p>
<p><a href="https://travis-ci.org/moajs/mongoosedao" target="_blank" rel="external"><img src="https://travis-ci.org/moajs/mongoosedao.png?branch=master" alt="Build Status"></a><br><a href="https://coveralls.io/r/moajs/mongoosedao" target="_blank" rel="external"><img src="https://coveralls.io/repos/moajs/mongoosedao/badge.png" alt="Coverage Status"></a></p>
<h2 id="另外一种用Makefile的玩法实践">另外一种用Makefile的玩法实践</h2><p>举例：<a href="https://github.com/node-webot/wechat-api/blob/master/Makefile" target="_blank" rel="external">https://github.com/node-webot/wechat-api/blob/master/Makefile</a></p>
<pre><code><span class="constant">TESTS </span>= test/*.js
<span class="constant">REPORTER </span>= spec
<span class="constant">TIMEOUT </span>= <span class="number">20000</span>
<span class="constant">ISTANBUL </span>= ./node_modules/.bin/istanbul
<span class="constant">MOCHA </span>= ./node_modules/mocha/bin/<span class="constant">_mocha</span>
<span class="constant">COVERALLS </span>= ./node_modules/coveralls/bin/coveralls.js

<span class="symbol">test:</span>
    <span class="variable">@NODE_ENV</span>=test <span class="variable">$(</span><span class="constant">MOCHA)</span> -<span class="constant">R </span><span class="variable">$(</span><span class="constant">REPORTER)</span> -t <span class="variable">$(</span><span class="constant">TIMEOUT)</span> \
        <span class="variable">$(</span><span class="constant">MOCHA_OPTS)</span> \
        <span class="variable">$(</span><span class="constant">TESTS)</span>

test-<span class="symbol">cov:</span>
    @<span class="variable">$(</span><span class="constant">ISTANBUL)</span> cover --report html <span class="variable">$(</span><span class="constant">MOCHA)</span> -- -t <span class="variable">$(</span><span class="constant">TIMEOUT)</span> -<span class="constant">R </span>spec <span class="variable">$(</span><span class="constant">TESTS)</span>

test-<span class="symbol">coveralls:</span>
    @<span class="variable">$(</span><span class="constant">ISTANBUL)</span> cover --report lcovonly <span class="variable">$(</span><span class="constant">MOCHA)</span> -- -t <span class="variable">$(</span><span class="constant">TIMEOUT)</span> -<span class="constant">R </span>spec <span class="variable">$(</span><span class="constant">TESTS)</span>
    <span class="variable">@echo</span> <span class="constant">TRAVIS_JOB_ID </span><span class="variable">$(</span><span class="constant">TRAVIS_JOB_ID)</span>
    <span class="variable">@cat</span> ./coverage/lcov.info | <span class="variable">$(</span><span class="constant">COVERALLS)</span> &amp;&amp; rm -rf ./coverage

test-<span class="symbol">all:</span> test test-coveralls

.<span class="constant">PHONY:</span> test
</code></pre><p>我个人更喜欢npm+gulp的写法，总是有一种make是c里古老的东东。。。</p>
<h2 id="总结">总结</h2><p>本文讲了</p>
<ul>
<li>nodejs里常用框架<ul>
<li>mocha</li>
<li>tape</li>
<li>tap</li>
<li>前沿技术：cucumber和vowsjs</li>
</ul>
</li>
<li>科普一下CI</li>
<li>测试报告<ul>
<li>istanbul</li>
</ul>
</li>
<li>实践<ul>
<li>gulp + npm run</li>
<li>mocha</li>
<li>travis-ci</li>
<li>coveralls</li>
</ul>
</li>
<li>介绍了基于makefile的另一种玩法</li>
</ul>
<p>全文完</p>
<p>欢迎关注我的公众号【node全栈】</p>
<p><img src="/img/node全栈-公众号.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/06/28/think/" data-id="cid185jhv0008q37fjga9zymv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/06/30/slb-vs-haproxy/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Nodejs负载均衡：haproxy，slb以及node-slb
        
      </div>
    </a>
  
  
    <a href="/2015/06/28/mongodb-repl-sets/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">mongodb运维之副本集实践</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/jekyll-update/">jekyll update</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-update/">node update</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/08/07/mongoose-cli/">mongoose-cli</a>
          </li>
        
          <li>
            <a href="/2015/07/12/to-us/">良苦用心几人懂</a>
          </li>
        
          <li>
            <a href="/2015/07/07/gulp-in-action/">gulp结构化</a>
          </li>
        
          <li>
            <a href="/2015/07/07/npm-postinstall/">从npm tips到express插件机制设计</a>
          </li>
        
          <li>
            <a href="/2015/07/04/mongo-paging/">mongodb分页优化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>